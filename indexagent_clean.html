<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="./style.css" />
		<title>Agent Test Environment</title>
	</head>

	<body>
		<div id="div1"></div>
		
		<!-- Game Info Display - Fixed Overlay -->
		<div id="losUI" style="position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px; border: 1px solid black; font-size: 12px; z-index: 1000;">
			<strong>Agent Test Environment</strong>
			<div id="agentScores">Loading scores...</div>
			<div id="testTimer">Timer: 0</div>
			<div style="font-size: 11px;">
				Camera: Mouse look, Scroll zoom
			</div>
		</div>

		<!-- Game Controls - Fixed Overlay -->
		<div id="game-controls" style="position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 8px; border: 1px solid black; font-size: 12px; z-index: 1000; max-width: 300px;">
			<h4 style="margin: 0 0 5px 0;">Game Controls</h4>
			<div style="margin: 2px 0;">Mode: <span id="current-mode">Random</span></div>
			<div style="margin: 2px 0;">Status: <span id="system-status">Ready</span></div>
			
			<div style="margin: 3px 0;">
				<button id="reset-scene">Reset Environment</button>
				<button id="random-mode">Random Mode</button>
			</div>
		</div>
		
		<script>
			// Simple timer to show the page is working
			let timerCount = 0;
			setInterval(() => {
				timerCount++;
				const timerDiv = document.getElementById('testTimer');
				if (timerDiv) {
					timerDiv.textContent = `Timer: ${timerCount} (${new Date().toLocaleTimeString()})`;
				}
			}, 1000);
		</script>
		
	<script type="importmap">
		{
			"imports": {
				"three": "https://unpkg.com/three@0.161.0/build/three.module.js",
				"three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
			}
		}
	</script>

	<script type="module">
		import * as THREE from 'three';
		import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
		import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { CriticalPointSystem, CP_COLORS } from './critical-point-system.js';
		
		// Expose Three.js and related systems to global scope
		window.THREE = THREE;
		window.OBJLoader = OBJLoader;
		window.MTLLoader = MTLLoader;
		window.CriticalPointSystem = CriticalPointSystem;
		window.CP_COLORS = CP_COLORS;
		
		// Setup basic game controls when page loads
		window.addEventListener('load', () => {
			console.log('Setting up basic game controls');
			
			const setupControls = () => {
				if (!window.gameManager) {
					setTimeout(setupControls, 200);
					return;
				}
				
				console.log('Game manager ready, connecting basic controls');
				
				// Utility function for resetting critical points (used by UI)
				window.resetCriticalPointsUtil = function() {
					const cps = window.gameManager?.criticalPointSystem;
					if (!cps) return;

					console.log('Utility: Resetting critical points...');
					console.log(`Before reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);

					// Reset existing critical points to neutral state
					if (cps.criticalPoints && cps.criticalPoints.length > 0) {
						console.log(`Resetting ${cps.criticalPoints.length} existing critical points to neutral state`);
						
						cps.criticalPoints.forEach(cpData => {
							if (cpData.cp && cpData.cp.material) {
								// Reset to original/neutral color
								cpData.cp.material.color.setHex(cpData.originalColor || 0xffffff);
								cpData.cp.material.opacity = 0.8;
								
								// Reset any glow children
								if (cpData.cp.children && cpData.cp.children.length > 0) {
									cpData.cp.children.forEach(child => {
										if (child.material) {
											child.material.color.setHex(cpData.originalColor || 0xffffff);
										}
									});
								}
							}
							
							// Reset ownership and state
							cpData.ownedBy = null;
							cpData.currentOwner = null;
							if (cpData.fillProgress !== undefined) {
								cpData.fillProgress = 0;
							}
							if (cpData.currentColor) {
								cpData.currentColor = cpData.originalColor || 0xffffff;
							}
						});
						
						// Reset registry ownership but keep the critical points
						if (cps.cpsByOwner) {
							cps.cpsByOwner.clear();
						}
						
						// Reset registry states but don't clear the points themselves
						if (cps.cpRegistry) {
							cps.cpRegistry.forEach((cpData, id) => {
								cpData.ownedBy = null;
								cpData.isActivelyClaimed = false;
								cpData.claimedBy = null;
								cpData.lastClaimedTime = 0;
								if (cpData.claimHistory) {
									cpData.claimHistory = [];
								}
							});
						}
					} else {
						console.log('No existing critical points found to reset');
					}

					console.log('Utility: Critical points reset completed');
					console.log(`After reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);
				};
				
				// UI elements for basic controls
				const modeSpan = document.getElementById('current-mode');
				const statusSpan = document.getElementById('system-status');
				
				console.log('Basic game controls ready');
				
				// Reset Scene
				document.getElementById('reset-scene').onclick = () => {
					console.log('Resetting environment...');
					
					// Reset agents to starting positions
					if (window.gameManager && window.gameManager.agents) {
						window.gameManager.agents.forEach((agent, index) => {
							// Calculate starting position (spread around circle)
							const angle = (index / window.gameManager.agents.length) * 2 * Math.PI;
							const radius = 15;
							const x = Math.cos(angle) * radius;
							const z = Math.sin(angle) * radius;
							const y = 0.5;
							
							if (agent.mesh) {
								agent.mesh.position.set(x, y, z);
								agent.mesh.rotation.set(0, 0, 0);
							}
							
							// Reset scores and state
							if (agent.claimedCriticalPoints) {
								agent.claimedCriticalPoints.clear();
							}
							if (agent.testScore !== undefined) {
								agent.testScore = 0;
							}
							if (agent.velocity) {
								agent.velocity.set(0, 0, 0);
							}
						});
					}
					
					// Reset critical points
					if (window.resetCriticalPointsUtil) {
						window.resetCriticalPointsUtil();
					}
					
					// Update UI
					if (modeSpan) modeSpan.textContent = 'Random';
					if (statusSpan) statusSpan.textContent = 'Environment reset';
					
					console.log('Environment reset complete');
				};
				
				// Random Mode
				document.getElementById('random-mode').onclick = () => {
					console.log('Setting random mode');
					window.gameManager.setAllAgentsMode('random');
					if (modeSpan) modeSpan.textContent = 'Random';
					if (statusSpan) statusSpan.textContent = 'Random mode active';
				};
				
				console.log('Basic game controls connected successfully');
			};
			
			setupControls();
		});
		
		console.log('Basic game system initialized');
	</script>

	<script src="AgentTestMain.js" type="module" defer></script>
	</body>
</html>
