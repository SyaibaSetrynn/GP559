<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="./style.css" />
		<title>DQN Training Environment</title>
		
		<!-- TensorFlow.js -->
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
	</head>

	<body>
		<div id="div1"></div>
		
		<!-- Game Info Display - Fixed Overlay -->
		<div id="losUI" style="position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px; border: 1px solid black; font-size: 12px; z-index: 1000;">
			<strong>DQN Training Environment</strong>
			<div id="agentScores">Loading scores...</div>
			<div id="testTimer">Timer: 0</div>
			<div style="font-size: 11px;">
				Camera: Mouse look, Scroll zoom<br>
				DQN: Deep Q-Network training
			</div>
		</div>

		<!-- Game Controls - Fixed Overlay -->
		<div id="game-controls" style="position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 8px; border: 1px solid black; font-size: 12px; z-index: 1000; max-width: 300px;">
			<h4 style="margin: 0 0 5px 0;">Game Controls</h4>
			<div style="margin: 2px 0;">Mode: <span id="current-mode">Random</span></div>
			<div style="margin: 2px 0;">Status: <span id="system-status">Ready</span></div>
			
			<div style="margin: 3px 0;">
				<button id="reset-scene">Reset Environment</button>
				<button id="random-mode">Random Mode</button>
			</div>
			
			<div style="margin-top: 6px; border-top: 1px solid #ccc; padding-top: 4px;">
				<h5 style="margin: 0 0 3px 0;">DQN Controls</h5>
				<div style="margin: 2px 0;">
					<button id="init-dqn" style="font-size: 10px;">Initialize DQN</button>
					<button id="start-dqn" style="font-size: 10px;">Start Training</button>
				</div>
				<div style="margin: 2px 0;">
					<button id="stop-dqn" style="font-size: 10px;">Stop Training</button>
					<button id="save-dqn" style="font-size: 10px;">Save Model</button>
				</div>
			</div>
		</div>

		<!-- Agent State Display - Fixed Overlay -->
		<div id="red-agent-state" style="position: fixed; bottom: 10px; left: 10px; background: rgba(240,240,240,0.95); border: 1px solid #ccc; padding: 8px; font-family: 'Courier New', monospace; font-size: 10px; z-index: 1000; max-width: 350px; color: #333;">
			<div style="margin: 0 0 6px 0; font-weight: bold; font-size: 11px;">Agent 0 State Data</div>
			<div id="red-state-summary" style="margin-bottom: 6px; line-height: 1.2;">
				<div>pos: <span id="red-position">Loading...</span></div>
				<div>score: <span id="red-score">Loading...</span></div>
				<div>move: <span id="red-movement">Loading...</span></div>
				<div>target: <span id="red-nearest-cp">Loading...</span></div>
			</div>
			<div id="red-minimal-state" style="font-size: 9px; color: #666; border-top: 1px solid #ddd; padding-top: 4px;">
				<div style="margin-bottom: 2px;">state_vector:</div>
				<div id="red-state-vector" style="font-family: monospace; word-break: break-all; line-height: 1.1;">[Loading...]</div>
			</div>
		</div>
		
		<script>
			// Simple timer to show the page is working
			let timerCount = 0;
			setInterval(() => {
				timerCount++;
				const timerDiv = document.getElementById('testTimer');
				if (timerDiv) {
					timerDiv.textContent = `Timer: ${timerCount} (${new Date().toLocaleTimeString()})`;
				}
			}, 1000);
		</script>
		
	<script type="importmap">
		{
			"imports": {
				"three": "https://unpkg.com/three@0.161.0/build/three.module.js",
				"three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
			}
		}
	</script>

	<script type="module">
		import * as THREE from 'three';
		import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
		import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { CriticalPointSystem, CP_COLORS } from './critical-point-system.js';
		import { gameStateExtractor } from './dqn/game-state-extractor.js';
		import { dqnIntegration } from './dqn/dqn-integration.js';
		
		// Expose Three.js and related systems to global scope
		window.THREE = THREE;
		window.OBJLoader = OBJLoader;
		window.MTLLoader = MTLLoader;
		window.CriticalPointSystem = CriticalPointSystem;
		window.CP_COLORS = CP_COLORS;
		window.gameStateExtractor = gameStateExtractor;
		window.dqnIntegration = dqnIntegration;

		// Red Agent State Display Update
		function updateRedAgentStateDisplay() {
			try {
				// Get the red agent (first agent, which should be red)
				const redAgent = window.gameManager?.agents?.[0];
						if (!redAgent) {
				// Update UI to show no agent found
				document.getElementById('red-position').textContent = 'No red agent found';
				document.getElementById('red-score').textContent = 'N/A';
				document.getElementById('red-movement').textContent = 'N/A';
				document.getElementById('red-nearest-cp').textContent = 'N/A';
				document.getElementById('red-state-vector').textContent = '[Agent not found]';
				return;
			}

				// Get the required system references
				const agentManager = window.gameManager;
				const mapLayout = window.mapLayout; // Use mapLayout instead of levelContent3D
				const criticalPointSystem = window.globalCPSystem;

				// Get human-readable summary
				const summary = gameStateExtractor.getStateSummary(
					redAgent, agentManager, mapLayout, criticalPointSystem
				);

				// Get minimal state vector for DQN
				const stateVector = gameStateExtractor.getMinimalStateVector(
					redAgent, agentManager, mapLayout, criticalPointSystem
				);

				// Update UI elements
				document.getElementById('red-position').textContent = summary.position || '(0.0, 0.0)';
				document.getElementById('red-score').textContent = summary.score || '0/0 CPs owned';
				document.getElementById('red-movement').textContent = summary.movement || 'Unknown';
				document.getElementById('red-nearest-cp').textContent = summary.nearestCP || 'None available';
				
				// Format state vector nicely
				const formattedVector = stateVector.map(val => 
					typeof val === 'number' ? val.toFixed(2) : val
				).join(', ');
				document.getElementById('red-state-vector').textContent = `[${formattedVector}]`;
		} catch (error) {
			console.warn('Error updating red agent state display:', error);
			document.getElementById('red-position').textContent = 'Error';
			document.getElementById('red-score').textContent = 'Error';
			document.getElementById('red-movement').textContent = 'Error';
			document.getElementById('red-nearest-cp').textContent = 'Error';
			document.getElementById('red-state-vector').textContent = '[Error extracting state]';
		}
		}

		// Start the state display update loop
		let stateUpdateInterval;
		function startRedAgentStateUpdates() {
			if (stateUpdateInterval) {
				clearInterval(stateUpdateInterval);
			}
			
			// Update every 500ms
			stateUpdateInterval = setInterval(updateRedAgentStateDisplay, 500);
			console.log('Red agent state display updates started');
		}

		// Expose functions globally for debugging
		window.updateRedAgentStateDisplay = updateRedAgentStateDisplay;
		window.startRedAgentStateUpdates = startRedAgentStateUpdates;
		
		// Setup basic game controls when page loads
		window.addEventListener('load', () => {
			console.log('Setting up DQN environment controls');
			
			const setupControls = () => {
				if (!window.gameManager) {
					setTimeout(setupControls, 200);
					return;
				}
				
				console.log('Game manager ready, connecting DQN controls');
				
				// Start red agent state display updates
				startRedAgentStateUpdates();
				
				// Utility function for resetting critical points (used by UI)
				window.resetCriticalPointsUtil = function() {
					const cps = window.gameManager?.criticalPointSystem;
					if (!cps) return;

					console.log('Utility: Resetting critical points...');
					console.log(`Before reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);

					// Reset existing critical points to neutral state
					if (cps.criticalPoints && cps.criticalPoints.length > 0) {
						console.log(`Resetting ${cps.criticalPoints.length} existing critical points to neutral state`);
						
						cps.criticalPoints.forEach(cpData => {
							if (cpData.cp && cpData.cp.material) {
								// Reset to original/neutral color
								cpData.cp.material.color.setHex(cpData.originalColor || 0xffffff);
								cpData.cp.material.opacity = 0.8;
								
								// Reset any glow children
								if (cpData.cp.children && cpData.cp.children.length > 0) {
									cpData.cp.children.forEach(child => {
										if (child.material) {
											child.material.color.setHex(cpData.originalColor || 0xffffff);
										}
									});
								}
							}
							
							// Reset ownership and state
							cpData.ownedBy = null;
							cpData.currentOwner = null;
							if (cpData.fillProgress !== undefined) {
								cpData.fillProgress = 0;
							}
							if (cpData.currentColor) {
								cpData.currentColor = cpData.originalColor || 0xffffff;
							}
						});
						
						// Reset registry ownership but keep the critical points
						if (cps.cpsByOwner) {
							cps.cpsByOwner.clear();
						}
						
						// Reset registry states but don't clear the points themselves
						if (cps.cpRegistry) {
							cps.cpRegistry.forEach((cpData, id) => {
								cpData.ownedBy = null;
								cpData.isActivelyClaimed = false;
								cpData.claimedBy = null;
								cpData.lastClaimedTime = 0;
								if (cpData.claimHistory) {
									cpData.claimHistory = [];
								}
							});
						}
					} else {
						console.log('No existing critical points found to reset');
					}

					console.log('Utility: Critical points reset completed');
					console.log(`After reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);
				};
				
				// UI elements for basic controls
				const modeSpan = document.getElementById('current-mode');
				const statusSpan = document.getElementById('system-status');
				
				console.log('Basic game controls ready');
				
				// Reset Scene
				document.getElementById('reset-scene').onclick = () => {
					console.log('Resetting environment...');
					
					// Reset agents to starting corner positions
					if (window.gameManager && window.gameManager.agents) {
						// Define starting corner positions (matching AgentTestMain.js)
						const startingPositions = [
							{ x: -4, y: 1, z: -4 }, // Red agent - back left corner
							{ x: 4, y: 1, z: -4 },  // Green agent - back right corner  
							{ x: -4, y: 1, z: 4 },  // Blue agent - front left corner
							{ x: 4, y: 1, z: 4 }    // Extra corner if needed - front right corner
						];
						
						window.gameManager.agents.forEach((agent, index) => {
							// Get starting position for this agent (cycle through corners if more agents)
							const startPos = startingPositions[index % startingPositions.length];
							
							// Reset agent mesh position
							if (agent.mesh) {
								agent.mesh.position.set(startPos.x, startPos.y, startPos.z);
								agent.mesh.rotation.set(0, 0, 0);
							}
							
							// Reset agent camera position (important for agent physics)
							if (agent.camera) {
								agent.camera.position.set(startPos.x, startPos.y, startPos.z);
							}
							
							// Reset collider position
							if (agent.collider) {
								agent.collider.start.set(startPos.x, startPos.y - 0.25, startPos.z);
								agent.collider.end.set(startPos.x, startPos.y + 0.25, startPos.z);
							}
							
							// Reset scores and state
							if (agent.claimedCriticalPoints) {
								agent.claimedCriticalPoints.clear();
							}
							if (agent.testScore !== undefined) {
								agent.testScore = 0;
							}
							if (agent.velocity) {
								agent.velocity.set(0, 0, 0);
							}
							
							// Reset movement state
							if (agent.movement) {
								agent.movement = {w: false, a: false, s: false, d: false, space: false, spaceHold: false};
							}
							
							// Reset physics
							agent.speedY = 0;
							agent.onGround = true;
							
							console.log(`Agent ${agent.agentId} reset to corner (${startPos.x}, ${startPos.y}, ${startPos.z})`);
						});
					}
					
					// Reset critical points
					if (window.resetCriticalPointsUtil) {
						window.resetCriticalPointsUtil();
					}
					
					// Update UI
					if (modeSpan) modeSpan.textContent = 'Random';
					if (statusSpan) statusSpan.textContent = 'Environment reset';
					
					console.log('Environment reset complete');
				};
				
				// Random Mode
				document.getElementById('random-mode').onclick = () => {
					console.log('Setting random mode');
					window.gameManager.setAllAgentsMode('random');
					if (modeSpan) modeSpan.textContent = 'Random';
					if (statusSpan) statusSpan.textContent = 'Random mode active';
				};
				
				// DQN Controls
				document.getElementById('init-dqn').onclick = async () => {
					console.log('Initializing DQN...');
					if (statusSpan) statusSpan.textContent = 'Initializing DQN...';
					
					try {
						await dqnIntegration.initialize(window.gameManager, {
							scene: window.scene,
							collisionWorld: window.collisionWorld,
							criticalPointSystem: window.globalCPSystem,
							mapLayout: window.mapLayout
						});
						
						if (statusSpan) statusSpan.textContent = 'DQN Ready';
						console.log('DQN initialized successfully');
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'DQN Init Error';
						console.error('DQN initialization error:', error);
					}
				};
				
				document.getElementById('start-dqn').onclick = async () => {
					console.log('Starting DQN training...');
					if (statusSpan) statusSpan.textContent = 'Starting DQN training...';
					
					try {
						await dqnIntegration.startTraining(0); // Train red agent
						if (modeSpan) modeSpan.textContent = 'DQN Training';
						if (statusSpan) statusSpan.textContent = 'DQN training active';
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'DQN Start Error';
						console.error('DQN training start error:', error);
					}
				};
				
				document.getElementById('stop-dqn').onclick = () => {
					console.log('Stopping DQN training...');
					dqnIntegration.stopTraining();
					if (statusSpan) statusSpan.textContent = 'DQN training stopped';
				};
				
				document.getElementById('save-dqn').onclick = async () => {
					console.log('Saving DQN model...');
					if (statusSpan) statusSpan.textContent = 'Saving model...';
					
					try {
						const modelName = 'dqn_model_' + new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
						const success = await dqnIntegration.saveModel(modelName);
						if (statusSpan) {
							statusSpan.textContent = success ? 'Model saved' : 'Save failed';
						}
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'Save error';
						console.error('Model save error:', error);
					}
				};
				
				console.log('DQN game controls connected successfully');
			};
			
			setupControls();
		});
		
		console.log('DQN training system initialized');
	</script>

	<script src="AgentTestMain.js" type="module" defer></script>
	</body>
</html>
