<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="./style.css" />
		<title>DQN Training Environment</title>
		
		<!-- TensorFlow.js -->
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
		
		<!-- Custom Styles for Dark Theme -->
		<style>
			/* Dark theme for body */
			body {
				background-color: #0d1117;
				margin: 0;
				padding: 0;
			}
			
			/* Button hover effects */
			#right-panel button {
				transition: all 0.2s ease;
			}
			#right-panel button:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.4);
				opacity: 0.9;
			}
			#right-panel button:active {
				transform: translateY(0);
			}
			
			/* Scrollbar styling for right panel */
			#right-panel::-webkit-scrollbar {
				width: 8px;
			}
			#right-panel::-webkit-scrollbar-track {
				background: #2d3139;
			}
			#right-panel::-webkit-scrollbar-thumb {
				background: #555;
				border-radius: 4px;
			}
			#right-panel::-webkit-scrollbar-thumb:hover {
				background: #777;
			}
			
			/* Ensure game canvas uses full screen minus panel width and bottom space */
			#div1 {
				position: fixed;
				top: 0;
				left: 0;
				right: 320px;
				bottom: 85px;
				background-color: #0d1117;
				pointer-events: auto;
			}
			
			/* Ensure canvas fits within the div1 container */
			#div1 canvas {
				position: absolute !important;
				top: 0 !important;
				left: 0 !important;
				width: 100% !important;
				height: 100% !important;
				max-width: 100% !important;
				max-height: 100% !important;
			}
			
			/* Movement Speed Slider Styling */
			#movement-speed-slider {
				-webkit-appearance: none;
				appearance: none;
			}
			
			#movement-speed-slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #3fb950;
				cursor: pointer;
				border: 2px solid #21262d;
				box-shadow: 0 2px 4px rgba(0,0,0,0.3);
			}
			
			#movement-speed-slider::-webkit-slider-thumb:hover {
				background: #46d058;
				transform: scale(1.1);
			}
			
			#movement-speed-slider::-moz-range-thumb {
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #3fb950;
				cursor: pointer;
				border: 2px solid #21262d;
				box-shadow: 0 2px 4px rgba(0,0,0,0.3);
			}
		</style>
	</head>

	<body>
		<div id="div1"></div>
		
		<!-- Right Side Panel - All UI Elements -->
		<div id="right-panel" style="position: fixed; top: 0; right: 0; width: 320px; height: 100vh; background: #161b22; border-left: 1px solid #30363d; overflow-y: auto; z-index: 1000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #c9d1d9;">
			
			<!-- Header Section -->
			<div style="background: #21262d; color: #c9d1d9; padding: 15px; border-bottom: 1px solid #30363d;">
				<h3 style="margin: 0; font-size: 16px; font-weight: 600;">DQN Training Environment</h3>
				<div id="testTimer" style="font-size: 11px; opacity: 0.7; margin-top: 5px; color: #8b949e;">Timer: 0</div>
			</div>

			<!-- System Status Section -->
			<div style="padding: 15px; border-bottom: 1px solid #30363d;">
				<h4 style="margin: 0 0 10px 0; color: #c9d1d9; font-size: 14px;">System Status</h4>
				<div style="background: #0d1117; padding: 10px; border-radius: 6px; border: 1px solid #30363d;">
					<div style="margin: 5px 0; display: flex; justify-content: space-between;">
						<span style="color: #8b949e;">Mode:</span> <span id="current-mode" style="font-weight: bold; color: #3fb950;">Training</span>
					</div>
					<div style="margin: 5px 0; display: flex; justify-content: space-between;">
						<span style="color: #8b949e;">Status:</span> <span id="system-status" style="font-weight: bold; color: #3fb950;">Ready</span>
					</div>
					<div style="margin: 5px 0; display: flex; justify-content: space-between; font-size: 11px;">
						<span style="color: #8b949e;">Buffer:</span> <span id="buffer-status" style="color: #7d8590;">0 experiences</span>
					</div>
				</div>
			</div>

			<!-- Environment Controls -->
			<div style="padding: 15px; border-bottom: 1px solid #30363d;">
				<h4 style="margin: 0 0 10px 0; color: #c9d1d9; font-size: 14px;">Environment Controls</h4>
				<button id="reset-scene" style="width: 100%; padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px; margin-bottom: 8px;">Reset Environment</button>
				<button id="debug-cp" style="width: 100%; padding: 6px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 10px; margin-bottom: 8px;">Debug Critical Points</button>
				
				<!-- Movement Speed Slider -->
				<div style="margin-top: 8px;">
					<label for="movement-speed-slider" style="display: block; font-size: 12px; color: #8b949e; margin-bottom: 6px;">
						Agent Movement Speed: <span id="movement-speed-value" style="color: #3fb950; font-weight: bold;">0.025</span>
					</label>
					<input type="range" id="movement-speed-slider" min="0.005" max="0.1" step="0.005" value="0.025" 
						style="width: 100%; height: 4px; border-radius: 5px; background: #30363d; outline: none; appearance: none; cursor: pointer;">
					<div style="display: flex; justify-content: space-between; font-size: 10px; color: #8b949e; margin-top: 2px;">
						<span>0.005 (slow)</span>
						<span>0.1 (fast)</span>
					</div>
				</div>
			</div>
			
			<!-- DQN Controls -->
			<div style="padding: 15px; border-bottom: 1px solid #30363d;">
				<h4 style="margin: 0 0 10px 0; color: #c9d1d9; font-size: 14px;">DQN Controls</h4>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
					<button id="init-dqn" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Initialize DQN</button>
					<button id="start-dqn" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Start Training</button>
				</div>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
					<button id="stop-dqn" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Stop Training</button>
					<button id="save-dqn" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Save Model</button>
				</div>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
					<button id="export-model" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Export JSON</button>
					<button id="import-model" style="padding: 8px 12px; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; cursor: pointer; font-size: 11px;">Import JSON</button>
					<input type="file" id="import-file" accept=".json" style="display: none;">
				</div>
			</div>

			<!-- Agent Scores Section -->
			<div style="padding: 15px; border-bottom: 1px solid #30363d;">
				<h4 style="margin: 0 0 10px 0; color: #c9d1d9; font-size: 14px;">Agent Scores</h4>
				<div id="agentScores" style="background: #0d1117; padding: 10px; border-radius: 6px; border: 1px solid #30363d; font-size: 12px; line-height: 1.4; color: #c9d1d9;">Loading scores...</div>
			</div>
			
			<!-- Agent State Display -->
			<div style="padding: 15px; border-bottom: 1px solid #30363d;">
				<h4 style="margin: 0 0 10px 0; color: #c9d1d9; font-size: 14px;">Red Agent State</h4>
				<div id="red-agent-state" style="background: #0d1117; border-radius: 6px; padding: 12px; border: 1px solid #30363d;">
					<div id="red-state-summary" style="margin-bottom: 10px; line-height: 1.3; font-size: 12px;">
						<div style="margin: 4px 0; display: flex; justify-content: space-between;">
							<span style="font-weight: 600; color: #8b949e;">Position:</span> <span id="red-position" style="font-family: monospace; color: #7d8590;">Loading...</span>
						</div>
						<div style="margin: 4px 0; display: flex; justify-content: space-between;">
							<span style="font-weight: 600; color: #8b949e;">Score:</span> <span id="red-score" style="color: #f85149; font-weight: bold;">Loading...</span>
						</div>
						<div style="margin: 4px 0; display: flex; justify-content: space-between;">
							<span style="font-weight: 600; color: #8b949e;">Movement:</span> <span id="red-movement" style="color: #58a6ff;">Loading...</span>
						</div>
						<div style="margin: 4px 0; display: flex; justify-content: space-between;">
							<span style="font-weight: 600; color: #8b949e;">Target:</span> <span id="red-nearest-cp" style="color: #3fb950;">Loading...</span>
						</div>
					</div>
				</div>
			</div>
		</div>



		</div>


		
		<script>
			// Simple timer to show the page is working
			let timerCount = 0;
			setInterval(() => {
				timerCount++;
				const timerDiv = document.getElementById('testTimer');
				if (timerDiv) {
					timerDiv.textContent = `Timer: ${timerCount} (${new Date().toLocaleTimeString()})`;
				}
			}, 1000);
		</script>
		
	<script type="importmap">
		{
			"imports": {
				"three": "https://unpkg.com/three@0.161.0/build/three.module.js",
				"three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
			}
		}
	</script>

	<script type="module">
		import * as THREE from 'three';
		import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
		import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { CriticalPointSystem, CP_COLORS } from './critical-point-system.js';
		import { gameStateExtractor } from './dqn/game-state-extractor.js';
		import { dqnIntegration } from './dqn/dqn-integration.js';
		
		// Expose Three.js and related systems to global scope
		window.THREE = THREE;
		window.OBJLoader = OBJLoader;
		window.MTLLoader = MTLLoader;
		window.CriticalPointSystem = CriticalPointSystem;
		window.dqnIntegration = dqnIntegration;
		window.CP_COLORS = CP_COLORS;
		window.gameStateExtractor = gameStateExtractor;
		window.dqnIntegration = dqnIntegration;

		// Red Agent State Display Update
		function updateRedAgentStateDisplay() {
			try {
				// Get the red agent (first agent, which should be red)
				const redAgent = window.gameManager?.agents?.[0];
						if (!redAgent) {
				// Update UI to show no agent found with safety checks
				const safeUpdate = (id, text) => {
					const element = document.getElementById(id);
					if (element) element.textContent = text;
				};
				safeUpdate('red-position', 'No red agent found');
				safeUpdate('red-score', 'N/A');
				safeUpdate('red-movement', 'N/A');
				safeUpdate('red-nearest-cp', 'N/A');
				safeUpdate('red-state-vector', '[Agent not found]');
				return;
			}

				// Get the required system references
				const agentManager = window.gameManager;
				const mapLayout = window.mapLayout; // Use mapLayout instead of levelContent3D
				const criticalPointSystem = window.globalCPSystem;

				// Get human-readable summary
				const summary = gameStateExtractor.getStateSummary(
					redAgent, agentManager, mapLayout, criticalPointSystem
				);

				// Get minimal state vector for DQN
				const stateVector = gameStateExtractor.getMinimalStateVector(
					redAgent, agentManager, mapLayout, criticalPointSystem
				);

				// Update UI elements with safety checks
				const safeUpdate = (id, text) => {
					const element = document.getElementById(id);
					if (element) element.textContent = text;
				};
				
				safeUpdate('red-position', summary.position || '(0.0, 0.0)');
				safeUpdate('red-score', summary.score || '0/0 CPs owned');
				safeUpdate('red-movement', summary.movement || 'Unknown');
				safeUpdate('red-nearest-cp', summary.nearestCP || 'None available');
				
				// Format state vector nicely
				const formattedVector = stateVector.map(val => 
					typeof val === 'number' ? val.toFixed(2) : val
				).join(', ');
				safeUpdate('red-state-vector', `[${formattedVector}]`);
				
				// Update DQN panel agent info if available
				if (window.dqnIntegration && typeof window.dqnIntegration.updateAgentInfo === 'function') {
					window.dqnIntegration.updateAgentInfo(redAgent);
				}
		} catch (error) {
			console.warn('Error updating red agent state display:', error);
			// Safety checks for DOM elements
			const safeUpdate = (id, text) => {
				const element = document.getElementById(id);
				if (element) element.textContent = text;
			};
			safeUpdate('red-position', 'Error');
			safeUpdate('red-score', 'Error');
			safeUpdate('red-movement', 'Error');
			safeUpdate('red-nearest-cp', 'Error');
			safeUpdate('red-state-vector', '[Error extracting state]');
		}
		}

		// Start the state display update loop
		let stateUpdateInterval;
		function startRedAgentStateUpdates() {
			if (stateUpdateInterval) {
				clearInterval(stateUpdateInterval);
			}
			
			// Update every 500ms
			stateUpdateInterval = setInterval(updateRedAgentStateDisplay, 500);
			console.log('Red agent state display updates started');
		}

		// Expose functions globally for debugging
		window.updateRedAgentStateDisplay = updateRedAgentStateDisplay;
		window.startRedAgentStateUpdates = startRedAgentStateUpdates;
		
		// Setup basic game controls when page loads
		window.addEventListener('load', () => {
			console.log('Setting up DQN environment controls');
			
			const setupControls = () => {
				if (!window.gameManager) {
					setTimeout(setupControls, 200);
					return;
				}
				
				console.log('Game manager ready, connecting DQN controls');
				
				// Start red agent state display updates
				startRedAgentStateUpdates();
				
				// Start periodic buffer status updates
				setInterval(() => {
					updateBufferStatus();
				}, 1000); // Update every second
				
				// Utility function for resetting critical points (used by UI)
				window.resetCriticalPointsUtil = function() {
					const cps = window.gameManager?.criticalPointSystem;
					if (!cps) return;

					console.log('Utility: Resetting critical points...');
					console.log(`Before reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);

					// Reset existing critical points to neutral state
					if (cps.criticalPoints && cps.criticalPoints.length > 0) {
						console.log(`Resetting ${cps.criticalPoints.length} existing critical points to neutral state`);
						
						cps.criticalPoints.forEach(cpData => {
							if (cpData.cp && cpData.cp.material) {
								// Reset to original/neutral color
								cpData.cp.material.color.setHex(cpData.originalColor || 0xffffff);
								cpData.cp.material.opacity = 0.8;
								
								// Reset any glow children
								if (cpData.cp.children && cpData.cp.children.length > 0) {
									cpData.cp.children.forEach(child => {
										if (child.material) {
											child.material.color.setHex(cpData.originalColor || 0xffffff);
										}
									});
								}
							}
							
							// Reset ownership and state
							cpData.ownedBy = null;
							cpData.currentOwner = null;
							if (cpData.fillProgress !== undefined) {
								cpData.fillProgress = 0;
							}
							if (cpData.currentColor) {
								cpData.currentColor = cpData.originalColor || 0xffffff;
							}
						});
						
						// Reset registry ownership but keep the critical points
						if (cps.cpsByOwner) {
							cps.cpsByOwner.clear();
						}
						
						// Reset registry states but don't clear the points themselves
						if (cps.cpRegistry) {
							cps.cpRegistry.forEach((cpData, id) => {
								cpData.ownedBy = null;
								cpData.isActivelyClaimed = false;
								cpData.claimedBy = null;
								cpData.lastClaimedTime = 0;
								if (cpData.claimHistory) {
									cpData.claimHistory = [];
								}
							});
						}
					} else {
						console.log('No existing critical points found to reset');
					}

					console.log('Utility: Critical points reset completed');
					console.log(`After reset: ${cps.criticalPoints ? cps.criticalPoints.length : 0} critical points exist`);
				};
				
				// UI elements for basic controls
				const modeSpan = document.getElementById('current-mode');
				const statusSpan = document.getElementById('system-status');
				
				console.log('Basic game controls ready');
				
				// Reset Scene
				document.getElementById('reset-scene').onclick = () => {
					console.log('Resetting environment...');
					
					// Reset agents to starting corner positions
					if (window.gameManager && window.gameManager.agents) {
						// Define starting corner positions (matching AgentTestMain.js)
						const startingPositions = [
							{ x: -4, y: 1, z: -4 }, // Red agent - back left corner
							{ x: 4, y: 1, z: 4 },   // Green agent - front right corner (opposite)
							{ x: -4, y: 1, z: 4 },  // Blue agent - front left corner
							{ x: 4, y: 1, z: -4 }   // Extra corner if needed - back right corner
						];
						
						window.gameManager.agents.forEach((agent, index) => {
							// Get starting position for this agent (cycle through corners if more agents)
							const startPos = startingPositions[index % startingPositions.length];
							
							// Reset agent mesh position
							if (agent.mesh) {
								agent.mesh.position.set(startPos.x, startPos.y, startPos.z);
								agent.mesh.rotation.set(0, 0, 0);
							}
							
							// Reset agent camera position (important for agent physics)
							if (agent.camera) {
								agent.camera.position.set(startPos.x, startPos.y, startPos.z);
							}
							
							// Reset collider position
							if (agent.collider) {
								agent.collider.start.set(startPos.x, startPos.y - 0.25, startPos.z);
								agent.collider.end.set(startPos.x, startPos.y + 0.25, startPos.z);
							}
							
							// Reset scores and state
							if (agent.claimedCriticalPoints) {
								agent.claimedCriticalPoints.clear();
							}
							if (agent.testScore !== undefined) {
								agent.testScore = 0;
							}
							if (agent.velocity) {
								agent.velocity.set(0, 0, 0);
							}
							
							// Reset movement state
							if (agent.movement) {
								agent.movement = {w: false, a: false, s: false, d: false, space: false, spaceHold: false};
							}
							
							// Reset physics
							agent.speedY = 0;
							agent.onGround = true;
							
							console.log(`Agent ${agent.agentId} reset to corner (${startPos.x}, ${startPos.y}, ${startPos.z})`);
						});
					}
					
					// Reset critical points
					if (window.resetCriticalPointsUtil) {
						window.resetCriticalPointsUtil();
					}
					
					// Update UI
					if (modeSpan) modeSpan.textContent = 'Training';
					if (statusSpan) statusSpan.textContent = 'Environment reset';
					
					console.log('Environment reset complete');
				};
				
				// Debug Critical Points
				document.getElementById('debug-cp').onclick = () => {
					console.log('üîç DEBUGGING CRITICAL POINTS:');
					const cps = window.globalCPSystem;
					if (cps && cps.criticalPoints) {
						console.log(`Found ${cps.criticalPoints.length} critical points:`);
						cps.criticalPoints.forEach((cpData, i) => {
							const pos = cpData.cp.position;
							const inPlayArea = Math.abs(pos.x) <= 4.5 && Math.abs(pos.z) <= 4.5;
							console.log(`CP ${i}: (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)}) - ${inPlayArea ? '‚úÖ IN play area' : '‚ùå OUTSIDE play area'}`);
						});
					} else {
						console.log('No critical points found');
					}
				};

				// Movement Speed Slider
				const movementSpeedSlider = document.getElementById('movement-speed-slider');
				const movementSpeedValue = document.getElementById('movement-speed-value');
				
				if (movementSpeedSlider) {
					movementSpeedSlider.addEventListener('input', (e) => {
						const speed = parseFloat(e.target.value);
						
						// Update the display value
						if (movementSpeedValue) {
							movementSpeedValue.textContent = speed.toFixed(3);
						}
						
						// Update all agents' movement speed
						if (window.gameManager && window.gameManager.setGlobalMovementSpeed) {
							window.gameManager.setGlobalMovementSpeed(speed);
						}
						
						console.log(`Movement speed updated to: ${speed}`);
					});
					
					// Initialize with current speed when gameManager is ready
					const initSpeed = () => {
						if (window.gameManager && window.gameManager.getGlobalMovementSpeed) {
							const currentSpeed = window.gameManager.getGlobalMovementSpeed();
							movementSpeedSlider.value = currentSpeed;
							if (movementSpeedValue) {
								movementSpeedValue.textContent = currentSpeed.toFixed(3);
							}
							console.log(`Movement speed slider initialized with current speed: ${currentSpeed}`);
						} else {
							setTimeout(initSpeed, 200);
						}
					};
					
					initSpeed();
				}
				
				// Utility function to update buffer status
				function updateBufferStatus() {
					const bufferSpan = document.getElementById('buffer-status');
					if (bufferSpan && dqnIntegration) {
						try {
							const info = dqnIntegration.getPretrainingInfo();
							const bufferSize = info.currentBufferSize;
							const readyForTraining = info.readyForTraining;
							const percentage = Math.min(100, Math.round((bufferSize / info.trainingStartSize) * 100));
							
							bufferSpan.textContent = `${bufferSize} experiences (${percentage}%)`;
							bufferSpan.style.color = readyForTraining ? '#4CAF50' : '#666';
						} catch (error) {
							bufferSpan.textContent = '0 experiences';
						}
					}
				}



				// DQN Controls
				document.getElementById('init-dqn').onclick = async () => {
					console.log('Initializing DQN...');
					if (statusSpan) statusSpan.textContent = 'Initializing DQN...';
					
					try {
						await dqnIntegration.initialize(window.gameManager, {
							scene: window.scene,
							collisionWorld: window.collisionWorld,
							criticalPointSystem: window.globalCPSystem,
							mapLayout: window.mapLayout
						});
						
						if (statusSpan) statusSpan.textContent = 'DQN Ready';
						updateBufferStatus();
						console.log('DQN initialized successfully');
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'DQN Init Error';
						console.error('DQN initialization error:', error);
					}
				};
				
				document.getElementById('start-dqn').onclick = async () => {
					console.log('Starting DQN training...');
					if (statusSpan) statusSpan.textContent = 'Starting DQN training...';
					
					try {
						await dqnIntegration.startTraining(0); // Train red agent
						if (modeSpan) modeSpan.textContent = 'DQN Training';
						if (statusSpan) statusSpan.textContent = 'DQN training active';
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'DQN Start Error';
						console.error('DQN training start error:', error);
					}
				};
				
				document.getElementById('stop-dqn').onclick = () => {
					console.log('Stopping DQN training...');
					dqnIntegration.stopTraining();
					if (statusSpan) statusSpan.textContent = 'DQN training stopped';
				};
				
				document.getElementById('save-dqn').onclick = async () => {
					console.log('Saving DQN model...');
					if (statusSpan) statusSpan.textContent = 'Saving model...';
					
					try {
						const modelName = 'dqn_model_' + new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
						const success = await dqnIntegration.saveModel(modelName);
						if (statusSpan) {
							statusSpan.textContent = success ? 'Model saved' : 'Save failed';
						}
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'Save error';
						console.error('Model save error:', error);
					}
				};
				
				// Export model as JSON
				document.getElementById('export-model').onclick = async () => {
					try {
						// Get list of available models first
						const savedModels = await dqnIntegration.listSavedModels();
						
						if (savedModels.length === 0) {
							alert('No saved models to export');
							return;
						}
						
						let modelOptions = 'Select model to export:\n';
						savedModels.forEach((model, index) => {
							modelOptions += `${index + 1}. ${model.name} (${model.dateSaved})\n`;
						});
						
						const modelName = prompt(modelOptions + '\nEnter model name to export:', 
							savedModels.length > 0 ? savedModels[0].name : '');
						if (!modelName) return;
						
						if (statusSpan) statusSpan.textContent = 'Exporting...';
						const success = await dqnIntegration.exportModelAsJSON(modelName);
						
						if (success) {
							alert(`Model ${modelName} exported successfully as JSON file!`);
						} else {
							alert('Export failed. Check console for details.');
						}
						
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'Export error';
						console.error('Model export error:', error);
						alert('Export failed. Check console for details.');
					}
				};
				
				// Import model from JSON
				document.getElementById('import-model').onclick = () => {
					document.getElementById('import-file').click();
				};
				
				document.getElementById('import-file').onchange = async (event) => {
					const file = event.target.files[0];
					if (!file) return;
					
					try {
						if (statusSpan) statusSpan.textContent = 'Importing...';
						
						const importedName = await dqnIntegration.importModelFromJSON(file);
						alert(`Model imported successfully as: ${importedName}`);
						
						if (statusSpan) statusSpan.textContent = 'Import complete';
						
						// Clear the file input
						event.target.value = '';
						
					} catch (error) {
						if (statusSpan) statusSpan.textContent = 'Import error';
						console.error('Model import error:', error);
						alert('Import failed. Check console for details.');
						event.target.value = '';
					}
				};
				console.log('DQN game controls connected successfully');
				
				// Movement Tuning Control Functions
				function setupMovementTuningControls() {
					console.log('Setting up movement tuning controls...');
					
					// Update display values when sliders change
					const updateSliderDisplay = (sliderId, displayId, suffix = '') => {
						const slider = document.getElementById(sliderId);
						const display = document.getElementById(displayId);
						if (slider && display) {
							slider.addEventListener('input', (e) => {
								display.textContent = parseFloat(e.target.value).toFixed(2) + suffix;
							});
						}
					};
					
					// Setup all slider displays
					updateSliderDisplay('movement-speed', 'speed-value');
					updateSliderDisplay('direction-freq', 'freq-value');
					updateSliderDisplay('cp-seeking', 'cp-seeking-value', '%');
					updateSliderDisplay('exploration-bonus', 'exploration-value');
					updateSliderDisplay('diagonal-movement', 'diagonal-value', '%');
					
					// Apply Movement Settings Button
					document.getElementById('apply-movement-settings').onclick = () => {
						console.log('Applying movement settings...');
						
						const settings = {
							movementSpeed: parseFloat(document.getElementById('movement-speed').value),
							directionChangeFreq: parseInt(document.getElementById('direction-freq').value),
							cpSeekingChance: parseInt(document.getElementById('cp-seeking').value) / 100,
							explorationBonus: parseFloat(document.getElementById('exploration-bonus').value),
							diagonalChance: parseInt(document.getElementById('diagonal-movement').value) / 100
						};
						
						console.log('New movement settings:', settings);
						
						// Apply settings to all agents
						if (window.gameManager && window.gameManager.agents) {
							window.gameManager.agents.forEach((agent, index) => {
								// Update agent movement speed
								if (agent.movementSpeed !== undefined) {
									agent.movementSpeed = settings.movementSpeed;
								}
								
								// Update movement parameters (these will be read by the agent's movement logic)
								agent.movementTuning = {
									directionChangeFreq: settings.directionChangeFreq,
									cpSeekingChance: settings.cpSeekingChance,
									explorationBonus: settings.explorationBonus,
									diagonalChance: settings.diagonalChance
								};
								
								console.log(`Applied settings to Agent ${agent.agentId || index}`);
							});
						}
						
						// Store settings globally for new agents
						window.globalMovementSettings = settings;
						
						if (statusSpan) statusSpan.textContent = 'Movement settings applied';
						setTimeout(() => {
							if (statusSpan) statusSpan.textContent = 'Ready';
						}, 2000);
					};
					
					// Reset Movement Settings Button
					document.getElementById('reset-movement-settings').onclick = () => {
						console.log('Resetting movement settings to defaults...');
						
						// Reset sliders to default values
						document.getElementById('movement-speed').value = 0.05;
						document.getElementById('direction-freq').value = 60;
						document.getElementById('cp-seeking').value = 20;
						document.getElementById('exploration-bonus').value = 0.1;
						document.getElementById('diagonal-movement').value = 20;
						
						// Update displays
						document.getElementById('speed-value').textContent = '0.05';
						document.getElementById('freq-value').textContent = '60';
						document.getElementById('cp-seeking-value').textContent = '20%';
						document.getElementById('exploration-value').textContent = '0.10';
						document.getElementById('diagonal-value').textContent = '20%';
						
						// Apply default settings
						document.getElementById('apply-movement-settings').click();
						
						console.log('Movement settings reset to defaults');
					};
					
					// Toggle Movement Panel Button
					document.getElementById('toggle-movement-panel').onclick = () => {
						const panel = document.getElementById('movement-tuning');
						const button = document.getElementById('toggle-movement-panel');
						
						if (panel.style.display === 'none') {
							panel.style.display = 'block';
							button.textContent = 'Hide Panel';
						} else {
							panel.style.display = 'none';
							button.textContent = 'Show Movement Tuning';
							
							// Create a small show button if panel is hidden
							if (!document.getElementById('show-movement-btn')) {
								const showBtn = document.createElement('button');
								showBtn.id = 'show-movement-btn';
								showBtn.textContent = 'Movement';
								showBtn.style.cssText = 'position: fixed; top: 50%; right: 5px; transform: translateY(-50%); z-index: 1001; font-size: 8px; padding: 2px 4px; background: #ccc; color: black; border: 1px solid #999;';
								showBtn.onclick = () => {
									panel.style.display = 'block';
									button.textContent = 'Hide';
									document.body.removeChild(showBtn);
								};
								document.body.appendChild(showBtn);
							}
						}
					};
					
					console.log('Movement tuning controls ready');
				}
			};
			
			setupControls();
		});
		
		// Console helpers for testing pretraining
		window.pretrainHelpers = {
			async runPretraining() {
				console.log('üöÄ Starting pretraining from console...');
				
				// Start progress monitoring
				const progressMonitor = setInterval(() => {
					const progress = dqnIntegration.getPretrainingProgress();
					if (progress && progress.isPretraining) {
						console.log(`üìä Progress: Episode ${progress.currentEpisode}/${progress.totalEpisodes}, Step ${progress.currentStep}/${progress.stepsPerEpisode}`);
					}
				}, 2000); // Log progress every 2 seconds
				
				try {
					await dqnIntegration.runSimplePretraining(0);
					console.log('‚úÖ Pretraining completed!');
					updateBufferStatus();
				} catch (error) {
					console.error('‚ùå Pretraining error:', error);
				} finally {
					clearInterval(progressMonitor);
				}
			},
			
			getPretrainingInfo() {
				try {
					const info = dqnIntegration.getPretrainingInfo();
					console.log('üìä Pretraining Info:', info);
					return info;
				} catch (error) {
					console.error('Error getting pretraining info:', error);
					return null;
				}
			},
			
			getPretrainingProgress() {
				try {
					const progress = dqnIntegration.getPretrainingProgress();
					console.log('üìà Pretraining Progress:', progress);
					return progress;
				} catch (error) {
					console.error('Error getting pretraining progress:', error);
					return null;
				}
			},
			
			async trainWithPretraining() {
				console.log('üéØ Starting DQN training WITH pretraining...');
				try {
					await dqnIntegration.startTraining(0, true);
					console.log('‚úÖ Training with pretraining started!');
				} catch (error) {
					console.error('‚ùå Training error:', error);
				}
			}
		};
		
		console.log('DQN training system initialized');
		console.log('üí° Console helpers available: pretrainHelpers.runPretraining(), pretrainHelpers.getPretrainingInfo(), pretrainHelpers.getPretrainingProgress(), pretrainHelpers.trainWithPretraining()');
		console.log('üí° Or use the UI buttons: "Start Pretraining", "Train + Pretraining"');
		console.log('üí° Watch the UI for real-time pretraining progress display!');
	</script>


	<script src="AgentTestMain.js" type="module" defer></script>
	</body>
</html>
