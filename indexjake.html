<!DOCTYPE html>
<!-- Version: 2024-01-FINAL-V3 - Prevent multiple game instances -->
<html>
	<head>
		<link rel="stylesheet" href="./style.css" />
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			
			body {
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
				background-color: #1a1a1a;
				font-family: Arial, sans-serif;
			}
			
			#gameContainer {
				position: relative;
			}
			
			#gameCanvas {
				display: block;
				border: 2px solid #333;
				background-color: transparent;
				position: relative;
				z-index: 2; /* UI canvas on top */
			}
			
			#div1 {
				display: none; /* Initially hidden until game starts */
			}
			
			#menuOverlay {
				display: none; /* Will be controlled by the UI system */
			}
			
			#losUI {
				position: fixed; 
				top: 10px; 
				right: 10px; 
				color: white; 
				font-family: monospace; 
				font-size: 14px; 
				font-weight: bold; 
				text-align: right; 
				text-shadow: 2px 2px 4px rgba(0,0,0,0.8); 
				display: none; 
				pointer-events: none;
				z-index: 10000;
				background: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
			}
		</style>
	</head>

	<body>
		<div id="gameContainer">
			<canvas id="gameCanvas" width="1280" height="720"></canvas>
		</div>
		
		<div id="div1"></div>
		<div id="menuOverlay">
			<div id="startText">Click to Start</div>
		</div>
		
		<!-- Game Status UI -->
		<div id="losUI">
			<div id="agentScores">Loading scores...</div>
		</div>
	
	<!-- Import map MUST come first before any module scripts -->
	<script type="importmap">
		{
			"imports": {
				"three": "https://unpkg.com/three@0.161.0/build/three.module.js",
				"three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
			}
		}
	</script>

	<script type="module">
		import * as THREE from 'three';
		import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
		import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { Octree } from 'three/addons/math/Octree.js';
		import { OctreeHelper } from 'three/addons/helpers/OctreeHelper.js';
		import { Capsule } from 'three/addons/math/Capsule.js';
		import { CriticalPointSystem, CP_COLORS } from './critical-point-system.js';
		
		// Import Agent and AgentManager
		const AgentModule = await import('./Agent.js');
		const AgentManagerModule = await import('./AgentManager.js');
		
		// Expose Three.js and related systems to global scope
		window.THREE = THREE;
		window.T = THREE;  // Also expose as T for Player.js compatibility
		window.OBJLoader = OBJLoader;
		window.MTLLoader = MTLLoader;
		window.OrbitControls = OrbitControls;
		window.Octree = Octree;
		window.OctreeHelper = OctreeHelper;
		window.Capsule = Capsule;
		window.CriticalPointSystem = CriticalPointSystem;
		window.CP_COLORS = CP_COLORS;
		window.Agent = AgentModule.default;
		window.AgentManager = AgentManagerModule.default;
		
		// Expose global constants needed by Player.js
		window.PLAYER_HEIGHT = 0.5;
		window.PLAYER_RADIUS = 0.5 * Math.sqrt(2) / 2;
		window.PLAYER_SPEED = 0.02;
		window.PLAYER_JUMP_HEIGHT = 1.2;
		window.PLAYER_JUMP_SPEED = 0.03;
		window.WORLD_BOUNDARY = 20;
		window.GRAVITY = (window.PLAYER_JUMP_SPEED * window.PLAYER_JUMP_SPEED) / (2 * window.PLAYER_JUMP_HEIGHT);
		
		console.log('Three.js, loaders, and all required dependencies loaded successfully');
		
		// Initialize the UI system after everything loads
		window.addEventListener('load', () => {
			const canvas = document.getElementById('gameCanvas');
			if (canvas) {
				window.uiInstance = new UI(canvas);
				console.log('UI system initialized');
				
				// Set up the transition function for when level is selected
				window.transitionToGame = window.transitionToIndexJakeGame;
				
				// Override the LevelSelection3D enterLevel method when it's created
				setTimeout(() => {
					setupLevelTransition();
				}, 1000); // Give time for LevelSelection3D to be created
			}
		});
		
		function setupLevelTransition() {
			// Check if LevelSelection3D has been created and override enterLevel
			if (window.uiInstance && window.uiInstance.levelSelection3D) {
				console.log('Setting up level selection override...');
				const originalEnterLevel = window.uiInstance.levelSelection3D.enterLevel.bind(window.uiInstance.levelSelection3D);
				window.uiInstance.levelSelection3D.enterLevel = function(level) {
					console.log(`✓ Level ${level} selected! Starting transition...`);
					
					// Call the original enterLevel to continue normal UI flow
					originalEnterLevel(level).then(() => {
						console.log(`Original enterLevel completed for level ${level}`);
					}).catch(error => {
						console.error(`Error in original enterLevel:`, error);
					});
					
					// Start the 5-second timer to transition to indexjake
					window.transitionToIndexJakeGame(level);
				};
				console.log('✓ Level transition override set up successfully');
				console.log('✓ Click on a level or use the SKIP TO GAME button');
			} else {
				// Try again in a bit if not ready
				setTimeout(setupLevelTransition, 500);
			}
		}
		
		// Function to immediately start the game
		function startGameNow(level) {
			// Prevent duplicate starts
			if (window.gameStarting || (window.gameInstance && window.gameInstance.running)) {
				console.warn('⚠️ Game is already starting or running! Ignoring duplicate request.');
				return;
			}
			
			window.gameStarting = true;
			
			console.log(`========================================`);
			console.log(`STARTING GAME IMMEDIATELY for level ${level}`);
			console.log(`========================================`);
			
			// Hide the skip button
			const skipBtn = document.getElementById('skipToGame');
			if (skipBtn) {
				skipBtn.style.display = 'none';
			}
			
			// Stop the UI system
			if (window.uiInstance && window.uiInstance.stopRenderLoop) {
				window.uiInstance.stopRenderLoop();
				console.log('UI stopped');
			}
			
			// Hide UI elements
			const gameCanvas = document.getElementById('gameCanvas');
			const gameContainer = document.getElementById('gameContainer');
			const menuOverlay = document.getElementById('menuOverlay');
			
			if (gameCanvas) gameCanvas.style.display = 'none';
			if (gameContainer) gameContainer.style.display = 'none';
			if (menuOverlay) menuOverlay.style.display = 'none';
			
			// Show game container
			const div1 = document.getElementById('div1');
			if (div1) {
				div1.style.display = 'block';
				div1.style.position = 'fixed';
				div1.style.top = '0';
				div1.style.left = '0';
				div1.style.width = '100vw';
				div1.style.height = '100vh';
				div1.style.zIndex = '9999';
				console.log('Game container shown');
			}
			
			// Show game UI (make it visible and ensure z-index)
			const losUI = document.getElementById('losUI');
			if (losUI) {
				losUI.style.display = 'block';
				losUI.style.position = 'fixed';
				losUI.style.zIndex = '10000';
				losUI.style.top = '10px';
				losUI.style.right = '10px';
				console.log('Game UI shown');
			}
			
			// Start the game
			if (window.startIndexJakeGame) {
				console.log('Calling startIndexJakeGame...');
				try {
					window.startIndexJakeGame(level);
					console.log('✓ Game started successfully!');
					window.gameStarting = false; // Reset flag after successful start
				} catch (error) {
					console.error('ERROR starting game:', error);
					window.gameStarting = false; // Reset flag on error
					window.gameInstance = null; // Clear instance on error
				}
			} else {
				console.error('startIndexJakeGame function not found!');
				window.gameStarting = false; // Reset flag
			}
		}
		
		// Function to transition to indexjake game with selected level after 5 seconds
		window.transitionToIndexJakeGame = function(selectedLevel) {
			console.log(`========================================`);
			console.log(`Level ${selectedLevel} selected`);
			console.log(`UI will continue for 5 seconds...`);
			console.log(`========================================`);
			
			// Wait 5 seconds while the UI continues to work normally
			setTimeout(() => {
				console.log(`5 seconds elapsed - starting game now`);
				startGameNow(selectedLevel);
			}, 5000); // 5 seconds delay
		}
		
		// Make startGameNow globally accessible for debugging
		window.startGameNow = startGameNow;
	</script>

	<!-- Load non-module scripts AFTER the module script so dependencies are available -->
	<script src="StateManager.js"></script>
	<script src="LevelContent3D.js"></script>
	<script src="LevelSelection3D.js"></script>
	<script src="UI.js"></script>

	<!-- Player.js is a module that loads after other scripts -->
	<script src="Player.js" type="module"></script>
	</body>
</html>